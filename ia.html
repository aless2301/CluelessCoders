<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Revisor con IA - Future STEM Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS VISUALES DE FUTURE STEM LAB --- */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 40px 20px;
            background: #f7f8fa;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }
        
        h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            color: #003080;
            text-align: center;
        }

        p {
            font-size: 1.1em;
            color: #555;
            text-align: center;
            margin-bottom: 30px;
        }

        .btn-regresar {
            display: inline-block;
            margin-bottom: 30px;
            text-decoration: none;
            color: #004aad;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        .btn-regresar:hover {
            color: #003080;
            text-decoration: underline;
        }

        .revisor-card {
            border-radius: 12px;
            padding: 25px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .revisor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }

        #upload-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #upload-label {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #upload-label:hover {
            border-color: #004aad;
        }
        #upload-label span {
            color: #004aad;
            font-weight: 600;
        }
        #image-file {
            display: none;
        }

        #preview {
            max-width: 100%;
            margin-top: 15px;
            border-radius: 5px;
            display: none;
            border: 1px solid #e0e0e0;
        }

        button {
            background: #004aad;
            color: white;
            padding: 12px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
            font-size: 16px;
        }
        button:hover {
            background: #003080;
        }

        #feedback {
            margin-top: 20px;
            padding: 25px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            white-space: pre-wrap;
            line-height: 1.6;
        }

        /* Estilos para el nuevo formulario de nombre */
        .approved-card {
            margin-top: 20px;
            padding: 25px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .approved-card label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .approved-card input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box; /* Para que el padding no afecte el ancho total */
        }
    </style>
</head>

<body>

Â  Â  <div class="container">
Â  Â  Â  Â  <h1>Revisor de Circuitos IA</h1>
Â  Â  Â  Â  <p>Sube una foto (JPG) de tu circuito para que la IA lo revise segÃºn las instrucciones.</p>

Â  Â  Â  Â  <a href="/index.html" class="btn-regresar">â€¹ Volver a la pÃ¡gina principal</a>

Â  Â  Â  Â  <div class="revisor-card">
Â  Â  Â  Â  Â  Â  <form id="upload-form">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="image-file" id="upload-label">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Haz clic aquÃ­ para <span>seleccionar tu imagen</span>.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="image-file" name="circuitoJpg" accept="image/jpeg" required>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <img id="preview" alt="Vista previa de la imagen"/>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">Revisar Mi Circuito</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="feedback">
Â  Â  Â  Â  Â  Â  AquÃ­ aparecerÃ¡ la retroalimentaciÃ³n de la IA...
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="approved-form" class="approved-card" style="display: none;">
Â  Â  Â  Â  Â  Â  <p style="text-align: center;">Â¡Felicitaciones! ðŸŽ‰ Tu circuito ha sido aprobado.</p>
Â  Â  Â  Â  Â  Â  <p style="text-align: center;">Ingresa tu nombre y descarga tu diploma:</p>
Â  Â  Â  Â  Â  Â  <form id="name-form">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="nombreUsuario">Nombre:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="nombreUsuario" name="nombreUsuario" required>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" style="width: 100%; margin-top: 15px;">Descargar Diploma</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  const formUpload = document.getElementById('upload-form');
Â  Â  Â  Â  const formName = document.getElementById('name-form');
Â  Â  Â  Â  const divFeedback = document.getElementById('feedback');
Â  Â  Â  Â  const inputFile = document.getElementById('image-file');
Â  Â  Â  Â  const previewImage = document.getElementById('preview');
Â  Â  Â  Â  const uploadLabel = document.getElementById('upload-label');
Â  Â  Â  Â  const approvedForm = document.getElementById('approved-form');

Â  Â  Â  Â  // Muestra la vista previa de la imagen seleccionada
Â  Â  Â  Â  inputFile.addEventListener('change', () => {
Â  Â  Â  Â  Â  Â  const file = inputFile.files[0];
Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewImage.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewImage.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  uploadLabel.querySelector('p').innerHTML = `Archivo: <span>${file.name}</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Maneja el envÃ­o del formulario de la imagen
Â  Â  Â  Â  formUpload.addEventListener('submit', async (event) => {
Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  const imageFile = inputFile.files[0];
Â  Â  Â  Â  Â  Â  formData.append('circuitoJpg', imageFile);
Â  Â  Â  Â  Â  Â  divFeedback.innerText = "Analizando la imagen de tu circuito... Esto puede tardar un momento.";
Â  Â  Â  Â  Â  Â  previewImage.style.opacity = 0.5;

Â  Â  Â  Â  Â  Â  // Ocultar el formulario de nombre en cada nueva revisiÃ³n
Â  Â  Â  Â  Â  Â  approvedForm.style.display = 'none';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/revisar-circuito-jpg', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: formData,
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("El servidor respondiÃ³ con un error: " + response.status);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  divFeedback.innerText = data.feedback;

Â  Â  Â  Â  Â  Â  Â  Â  // LÃ“GICA CLAVE: Mostrar el formulario de nombre si la imagen fue aprobada
Â  Â  Â  Â  Â  Â  Â  Â  if (data.approved) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  approvedForm.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  divFeedback.innerText = "Â¡Oh no! Hubo un problema al enviar o procesar la imagen.";
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  previewImage.style.opacity = 1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- FUNCION CLAVE: DIBUJAR EL DIPLOMA EN EL CANVAS ---
Â  Â  Â  Â  function generateDiploma(name) {
Â  Â  Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  canvas.width = 1123; // Dimensiones A4 en 96dpi (orientaciÃ³n horizontal)
Â  Â  Â  Â  Â  Â  canvas.height = 794;
Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');

Â  Â  Â  Â  Â  Â  const logo = new Image();
Â  Â  Â  Â  Â  Â  logo.src = '/logo.png'; // AsegÃºrate de que esta ruta sea correcta

Â  Â  Â  Â  Â  Â  logo.onload = () => {
Â  Â  Â  Â  Â  Â  Â  Â  // --- DISEÃ‘O DEL DIPLOMA ---
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Fondo con degradado
Â  Â  Â  Â  Â  Â  Â  Â  const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  Â  Â  Â  Â  gradient.addColorStop(0, '#e8f2ff');
Â  Â  Â  Â  Â  Â  Â  Â  gradient.addColorStop(1, '#f7f8fa');
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = gradient;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(0, 0, canvas.width, canvas.height);

Â  Â  Â  Â  Â  Â  Â  Â  // Borde decorativo
Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#004aad';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineWidth = 15;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);

Â  Â  Â  Â  Â  Â  Â  Â  // Sombra para el texto principal
Â  Â  Â  Â  Â  Â  Â  Â  ctx.shadowColor = 'rgba(0,0,0,0.2)';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.shadowBlur = 5;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.shadowOffsetX = 3;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.shadowOffsetY = 3;

Â  Â  Â  Â  Â  Â  Â  Â  // TÃ­tulo
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#003080';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = 'bold 58px Poppins';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText('CERTIFICADO DE RECONOCIMIENTO', canvas.width / 2, 150);

Â  Â  Â  Â  Â  Â  Â  Â  // Texto de otorgamiento
Â  Â  Â  Â  Â  Â  Â  Â  ctx.shadowBlur = 0;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.shadowOffsetX = 0;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.shadowOffsetY = 0;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#555555';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = '28px Poppins';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText('Se otorga este diploma a:', canvas.width / 2, 250);

Â  Â  Â  Â  Â  Â  Â  Â  // Nombre del usuario
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#004aad';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = 'bold 64px Poppins';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText(name.toUpperCase(), canvas.width / 2, 350);

Â  Â  Â  Â  Â  Â  Â  Â  // Mensaje final
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#555555';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = '28px Poppins';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText('Por haber completado y aprobado el curso exitosamente', canvas.width / 2, 450);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText('demostrando un dominio excepcional en los temas.', canvas.width / 2, 490);

Â  Â  Â  Â  Â  Â  Â  Â  // Fecha
Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  const dateString = today.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = '20px Poppins';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText(`Expedido el ${dateString}`, canvas.width / 2, 600);

Â  Â  Â  Â  Â  Â  Â  Â  // Logo
Â  Â  Â  Â  Â  Â  Â  Â  const logoWidth = 150;
Â  Â  Â  Â  Â  Â  Â  Â  const logoHeight = (logo.height / logo.width) * logoWidth;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.drawImage(logo, (canvas.width / 2) - (logoWidth / 2), 610, logoWidth, logoHeight);

Â  Â  Â  Â  Â  Â  Â  Â  // --- DESCARGAR LA IMAGEN DEL DIPLOMA ---
Â  Â  Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  link.download = `Diploma_${name.replace(/\s/g, '_')}.png`;
Â  Â  Â  Â  Â  Â  Â  Â  link.href = canvas.toDataURL('image/png');
Â  Â  Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // Manejar el error de carga del logo
Â  Â  Â  Â  Â  Â  logo.onerror = () => {
Â  Â  Â  Â  Â  Â  Â  Â  divFeedback.innerText = "Error: No se pudo cargar el logo 'logo.png'. AsegÃºrate de que el archivo exista en la misma carpeta del servidor.";
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Maneja el envÃ­o del nuevo formulario del nombre ---
Â  Â  Â  Â  formName.addEventListener('submit', async (event) => {
Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  const nombre = document.getElementById('nombreUsuario').value;
Â  Â  Â  Â  Â  Â  divFeedback.innerText = `Generando tu diploma, ${nombre}...`;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // EnvÃ­a el nombre al servidor (opcional, pero Ãºtil para registrar el logro)
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/guardar-nombre', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ nombre: nombre })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  divFeedback.innerText = `Â¡Tu logro ha sido registrado! Descargando tu diploma...`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Llama a la funciÃ³n para dibujar y descargar el diploma
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  generateDiploma(nombre);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ocultar el formulario una vez enviado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  approvedForm.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  divFeedback.innerText = "Hubo un problema al guardar tu nombre.";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  divFeedback.innerText = "Hubo un error al conectar con el servidor.";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>